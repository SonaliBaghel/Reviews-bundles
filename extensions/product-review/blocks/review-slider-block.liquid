{% comment %}
  Customer review slider/grid displaying all approved testimonials
{% endcomment %}

{% assign avg_rating_initial = 0 %}
{% assign review_count_initial = 0 %}

<div class="review-slider-block loading"
  data-section-id="{{ section.id }}"
  data-api-url="/apps/productreview/api/settings"
>
  <div class="review-slider-header">
    <h2 class="section-title" id="review-section-title">CUSTOMER TESTIMONIALS</h2> 
    <div class="average-rating-summary">
      <span class="summary-label">Excellent</span>
      <span class="summary-stars-container"></span>
      <span class="summary-average-rating">0.0</span>
    </div>
    <p class="summary-review-count">
      Based on <span class="review-count-value">0</span> reviews
    </p>
  </div>

  {% comment %} Slider Layout {% endcomment %}
  <div class="review-carousel-container" style="display: none;">
    <button type="button" class="carousel-arrow carousel-arrow-left" aria-label="Previous reviews" style="display: none;">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
    </button>
    <div class="review-carousel-track-wrapper">
      <div class="review-carousel-track">
        <p class="loading-reviews-slider">Loading reviews...</p>
      </div>
    </div>
    <button type="button" class="carousel-arrow carousel-arrow-right" aria-label="Next reviews" style="display: none;">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 18l6-6-6-6"/>
      </svg>
    </button>
  </div>

  {% comment %} Grid Layout {% endcomment %}
  <div class="review-grid-container" style="display: none;">
    <div class="review-grid">
      <p class="loading-reviews-slider">Loading reviews...</p>
    </div>
    {% comment %} Grid Pagination Buttons {% endcomment %}
    <div class="grid-pagination" style="display: none;">
      <button type="button" class="grid-pagination-btn grid-pagination-prev" aria-label="Previous page">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <button type="button" class="grid-pagination-btn grid-pagination-next" aria-label="Next page">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
    </div>
  </div>

</div>

<!-- Review Popup Modal -->
<div id="review-popup" class="review-popup" style="display: none;">
  <div class="review-popup-overlay"></div>
  <div class="review-popup-content">
    <button class="review-popup-close" aria-label="Close review">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 6L6 18"/>
        <path d="M6 6l12 12"/>
      </svg>
    </button>
    <div class="review-popup-body">
      <h3 class="review-popup-title"></h3>
      <div class="review-popup-content-text"></div>
      <div class="review-popup-images"></div>
    </div>
  </div>
</div>

<style>
/* Base styles for the slider block */
.review-slider-block {
  padding: 3rem 0;
  background: var(--review-slider-bg, #f9f9f9);
  font-family: inherit;
  color: #333;
  text-align: center;
  overflow-x: hidden;
  position: relative;
  width: 100vw;
  max-width: 85vw;
  box-sizing: border-box;
  margin: 0 auto;
  border-radius: var(--section-border-radius, 12px);
}

.review-slider-block.loading {
  opacity: 0;
  pointer-events: none;
  visibility: hidden;
  transform: translateY(20px);
  transition: opacity 0.5s ease, transform 0.5s ease; 
}

.review-slider-block.loaded {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
  transition: opacity 0.5s ease, transform 0.5s ease;
}

.review-slider-header {
  margin-bottom: 2rem;
  padding: 0 20px;
}

.section-title {
  font-size: var(--heading-font-size, 2.5rem);
  font-family: var(--heading-font-family, inherit);
  font-weight: var(--heading-font-weight, 700);
  font-style: var(--heading-font-style, normal);
  text-transform: var(--heading-text-transform, uppercase);
  letter-spacing: var(--heading-letter-spacing, 0px);
  line-height: var(--heading-line-height, 1.2);
  text-shadow: var(--heading-text-shadow, none);
  margin-bottom: 0.5rem;
  color: var(--heading-color, #222);
}

.average-rating-summary {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

.summary-label {
  font-size: var(--rating-label-font-size, 1.1rem);
  font-family: var(--rating-label-font-family, inherit);
  font-weight: var(--rating-label-font-weight, 600);
  color: var(--rating-label-color, #555);
}

.summary-stars-container {
  font-size: 1.8rem;
  line-height: 1;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
}

/* Star styles */
.summary-stars-container .star-icon {
  display: inline-block;
  font-size: 1.8rem;
  line-height: 1;
  vertical-align: middle;
  color: #d3d3d3;
  position: relative;
}

.summary-stars-container .full-star-summary {
  color: var(--star-color, #FFD700);
}

.summary-stars-container .partial-star-summary::before {
  content: '★';
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  color: var(--star-color, #FFD700);
  overflow: hidden;
  white-space: nowrap;
  width: var(--fill-percentage);
}

.review-card-rating {
  font-size: 1.1rem;
  color: var(--star-color, #FFD700);
  letter-spacing: 2px;
  margin-bottom: 0.5rem;
}

.summary-average-rating {
  font-size: var(--rating-value-font-size, 1.1rem);
  font-family: var(--rating-value-font-family, inherit);
  font-weight: var(--rating-value-font-weight, 600);
  color: var(--rating-value-color, #555);
}

.summary-review-count {
  font-size: var(--review-count-font-size, 1rem);
  font-family: var(--review-count-font-family, inherit);
  font-weight: var(--review-count-font-weight, normal);
  color: var(--review-count-color, #777);
  margin-top: 0.3rem;
}

.review-carousel-container {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  width: 100%;
  margin: 0 auto;
  padding: 0 60px;
}

.review-carousel-track-wrapper {
  flex-grow: 1;
  overflow: hidden;
  position: relative;
  width: 100%;
}

.review-carousel-track {
  display: flex;
  transition: transform 0.5s ease-in-out;
  padding: 10px 0;
  width: 100%;
  gap: var(--space-between, 20px);
}

/* Effect styles */
.review-carousel-track.effect-fade {
  transition: opacity 0.5s ease-in-out !important;
}

.review-carousel-track.effect-cube {
  perspective: 1200px;
}

.review-carousel-track.effect-cube .review-card {
  transform-style: preserve-3d;
  transition: transform 0.5s ease-in-out;
}

.review-carousel-track.effect-coverflow {
  perspective: 1200px;
}

.review-carousel-track.effect-coverflow .review-card {
  transform-style: preserve-3d;
  transition: transform 0.5s ease-in-out;
}

/* Grid Layout Styles */
.review-grid-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
  position: relative;
}

.review-grid {
  display: grid;
  grid-template-columns: repeat(var(--grid-columns, 2), 1fr);
  grid-template-rows: repeat(var(--grid-rows, 2), auto);
  gap: var(--space-between, 25px);
  padding: 10px 0;
}

/* Grid Pagination Styles */
.grid-pagination {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px;
  margin-top: 2rem;
  padding: 0 20px;
}

.grid-pagination-btn {
  background: white;
  border: 1px solid #ddd;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease-in-out;
  color: #333;
}

.grid-pagination-btn:hover:not(:disabled) {
  background: var(--star-color, #FFD700);
  color: white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transform: scale(1.05);
}

.grid-pagination-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  box-shadow: none;
  background: #f1f1f1;
  color: #999;
}

.grid-pagination-btn svg {
  width: 20px;
  height: 20px;
  transition: all 0.3s ease-in-out;
}

.grid-pagination-btn:hover:not(:disabled) svg {
  stroke: white;
}

.review-card {
  flex: 0 0 calc(var(--card-width) - 20px);
  margin: 0 10px;
  background: var(--review-card-bg, #ffffff);
  border-radius: 12px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.08);
  padding: 1.5rem;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  min-height: 280px;
  text-align: left;
  transition: box-shadow 0.3s ease, transform 0.3s ease;
}

.review-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.review-grid .review-card {
  flex: 1 1 auto;
  margin: 0;
  min-height: 200px;
}

.review-card-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: #333;
  margin-bottom: 0.6rem;
}

.review-card-content {
  font-size: 0.95rem;
  line-height: 1.6;
  color: #444;
  margin-bottom: 0.8rem;
  flex-grow: 1;
  position: relative;
  overflow: hidden;
}

.review-card-content.collapsed {
  max-height: 8em; /* Approximately 5 lines (1.6 line-height * 5) */
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 5;
  -webkit-box-orient: vertical;
  margin-bottom: 0.5rem;
}

.review-card-content.expanded {
  max-height: none;
  -webkit-line-clamp: unset;
  display: block;
  margin-bottom: 0.8rem;
}

.read-more-btn {
  background: none;
  border: none;
  color: var(--star-color, #FFD700);
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  padding: 5px 0;
  margin: 0.5rem 0;
  text-decoration: underline;
  display: block;
  width: 100%;
  text-align: left;
}

.read-more-btn:hover {
  color: var(--star-color-darken, #E6C200);
}

.review-card-images-container {
  margin-top: 0.8rem;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: flex-start;
}

.review-card-images-container img {
  max-width: 70px;
  max-height: 70px;
  width: auto;
  height: auto;
  border-radius: 6px;
  object-fit: cover;
  border: 2px solid #eee;
  transition: border-color 0.3s ease;
}

.review-card-images-container img:hover {
  border-color: var(--star-color, #FFD700);
}

.review-card-meta {
  font-size: 0.8rem;
  color: #777;
  margin-top: 0.8rem;
  font-style: italic;
}

.carousel-arrow {
  background: white;
  border: 1px solid #ddd;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 10;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  transition: all 0.3s ease-in-out;
  position: absolute;
  top: 50%;
  transform: translateY(-50%) scale(1);
  color: #333;
}

.carousel-arrow:hover:not(:disabled) {
  background: var(--star-color, #FFD700);
  color: white;
  box-shadow: 0 6px 15px rgba(0,0,0,0.25);
  transform: translateY(-50%) scale(1.05);
}

.carousel-arrow:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  box-shadow: none;
  background: #f1f1f1;
  color: #999;
}

.carousel-arrow svg {
  width: 24px;
  height: 24px;
  transition: all 0.3s ease-in-out;
}
.slider-container, .review-card-track { 
   transform-style: preserve-3d; 
   perspective: 1000px; 
    
}
.carousel-arrow:hover:not(:disabled) svg {
  stroke: white;
}

.carousel-arrow-left {
  left: 0;
}

.carousel-arrow-right {
  right: 0;
}

.view-all-reviews-container {
  margin-top: 2.5rem;
  padding: 0 20px;
}

.view-all-reviews-btn {
  display: inline-block;
  background: var(--star-color, #FFD700);
  color: #333;
  padding: 0.7rem 1.8rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 700;
  font-size: 1rem;
  text-decoration: none;
  letter-spacing: 0.5px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.view-all-reviews-btn:hover {
  background: var(--star-color, #FFD700);
  filter: brightness(0.95);
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(0,0,0,0.2);
}

.loading-reviews-slider {
  color: #a0a0a0;
  font-style: italic;
  text-align: center;
  padding: 3rem 0;
  width: 100%;
  font-size: 1.1rem;
  animation: pulse 1.5s infinite ease-in-out;
}

@keyframes pulse {
  0% { opacity: 0.7; }
  50% { opacity: 1; }
  100% { opacity: 0.7; }
}

/* Review Popup Styles */
.review-popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  box-sizing: border-box;
}

.review-popup-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(5px);
}

.review-popup-content {
  position: relative;
  background: white;
  border-radius: 16px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: popupFadeIn 0.3s ease-out;
  display: flex;
  flex-direction: column;
}

@keyframes popupFadeIn {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.review-popup-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  background: #f5f5f5;
  transition: all 0.3s ease;
  z-index: 10;
}

.review-popup-close:hover {
  background: #e0e0e0;
  transform: scale(1.1);
}

.review-popup-close svg {
  width: 16px;
  height: 16px;
  color: #333;
}

.review-popup-body {
  padding: 2.5rem;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.review-popup-title {
  font-size: 1.4rem;
  font-weight: 700;
  color: #333;
  margin-bottom: 1.5rem;
  line-height: 1.3;
  text-align: center;
}

.review-popup-content-text {
  font-size: 1rem;
  line-height: 1.7;
  color: #444;
  margin-bottom: 1.5rem;
  flex: 1;
  overflow-y: auto;
  padding-right: 10px;
}

.review-popup-content-text::-webkit-scrollbar {
  width: 6px;
}

.review-popup-content-text::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.review-popup-content-text::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.review-popup-content-text::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.review-popup-images {
  margin: 1.5rem 0 0 0;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
}

.review-popup-images img {
  max-width: 120px;
  max-height: 120px;
  width: auto;
  height: auto;
  border-radius: 8px;
  object-fit: cover;
  border: 2px solid #eee;
  transition: border-color 0.3s ease;
}

.review-popup-images img:hover {
  border-color: var(--star-color, #FFD700);
  transform: scale(1.05);
}

/* Vertical slider styles */
.review-carousel-container.vertical {
  flex-direction: column;
  height: 600px;
}

.review-carousel-container.vertical .review-carousel-track {
  flex-direction: column;
  height: 100%;
}

.review-carousel-container.vertical .review-carousel-track-wrapper {
  height: 100%;
}

.review-carousel-container.vertical .carousel-arrow {
  left: 50%;
  transform: translateX(-50%);
}

.review-carousel-container.vertical .carousel-arrow-left {
  top: 0;
}

.review-carousel-container.vertical .carousel-arrow-right {
  top: auto;
  bottom: 0;
}

/* Responsive adjustments */
@media (max-width: 1600px) {
  .review-card {
    flex: 0 0 calc(var(--card-width-md) - 20px);
  }
}

@media (max-width: 1200px) {
  .review-card {
    flex: 0 0 calc(var(--card-width-sm) - 20px);
  }
  
  .review-grid {
    grid-template-columns: repeat(var(--grid-columns-sm, 2), 1fr);
  }
  .review-carousel-container {
    padding: 0 50px;
  }
}

@media (max-width: 992px) {
  .review-card {
    flex: 0 0 calc(var(--card-width-xs) - 20px);
  }
  
  .review-grid {
    grid-template-columns: repeat(var(--grid-columns-xs, 1), 1fr);
  }
  
  .review-popup-content {
    max-width: 90%;
    width: 95%;
    max-height: 85vh;
  }
  
  .review-popup-body {
    padding: 2rem;
  }
}

@media (max-width: 768px) {
  .section-title {
    font-size: calc(var(--heading-font-size, 40px) * 0.7);
  }
  .review-card {
    flex: 0 0 calc(100% - 10px);
    margin: 0 5px;
  }
  .review-carousel-container {
    padding: 0 10px;
  }
  .carousel-arrow {
    width: 40px;
    height: 40px;
  }
  .carousel-arrow svg {
    width: 20px;
    height: 20px;
  }
  
  .review-grid {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .review-carousel-container.vertical {
    height: 400px;
  }
  
  .grid-pagination {
    justify-content: center;
    margin-top: 1.5rem;
  }
  
  .review-popup-body {
    padding: 1.5rem;
  }
  
  .review-popup-title {
    font-size: 1.2rem;
  }
  
  .review-popup-images img {
    max-width: 80px;
    max-height: 80px;
  }
}

@media (max-width: 480px) {
  .review-slider-block {
    padding: 2rem 0;
  }
  .carousel-arrow-left {
    left: 0;
  }
  .carousel-arrow-right {
    right: 0;
  }
  
  .review-grid-container {
    padding: 0 10px;
  }
  
  .grid-pagination {
    padding: 0 10px;
  }
  
  .grid-pagination-btn {
    width: 40px;
    height: 40px;
  }
  
  .grid-pagination-btn svg {
    width: 18px;
    height: 18px;
  }
  
  .review-popup-body {
    padding: 1.2rem;
  }
  
  .review-popup-images {
    justify-content: center;
  }
  
  .review-popup-images img {
    max-width: 70px;
    max-height: 70px;
  }
  
  .review-popup-content {
    width: 95%;
    max-height: 90vh;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sliderBlock = document.querySelector('.review-slider-block');
  if (!sliderBlock) return;

  const elements = {
    sliderContainer: sliderBlock.querySelector('.review-carousel-container'),
    gridContainer: sliderBlock.querySelector('.review-grid-container'),
    track: sliderBlock.querySelector('.review-carousel-track'),
    grid: sliderBlock.querySelector('.review-grid'),
    prevBtn: sliderBlock.querySelector('.carousel-arrow-left'),
    nextBtn: sliderBlock.querySelector('.carousel-arrow-right'),
    gridPagination: sliderBlock.querySelector('.grid-pagination'),
    gridPrevBtn: sliderBlock.querySelector('.grid-pagination-prev'),
    gridNextBtn: sliderBlock.querySelector('.grid-pagination-next'),
    starsContainer: sliderBlock.querySelector('.summary-stars-container'),
    avgRating: sliderBlock.querySelector('.summary-average-rating'),
    count: sliderBlock.querySelector('.review-count-value'),
    sectionTitle: sliderBlock.querySelector('.section-title'),
    summaryLabel: sliderBlock.querySelector('.summary-label'),
    summaryReviewCount: sliderBlock.querySelector('.summary-review-count')
  };

  // Popup elements
  const popup = document.getElementById('review-popup');
  const popupOverlay = popup.querySelector('.review-popup-overlay');
  const popupClose = popup.querySelector('.review-popup-close');
  const popupTitle = popup.querySelector('.review-popup-title');
  const popupContent = popup.querySelector('.review-popup-content-text');
  const popupImages = popup.querySelector('.review-popup-images');

  let reviews = [];
  let currentIndex = 0;
  let gridCurrentPage = 0;
  let appSettings = {};
  let cardsPerPage = 3;
  let displayType = 'slider';
  let gridRows = 2;
  let gridColumns = 2;
  let sliderAutoplay = true;
  let sliderSpeed = 3000;
  let sliderLoop = true;
  let sliderDirection = 'horizontal';
  let spaceBetween = 20;
  let showNavigation = true;
  let sliderEffect = 'slide';
  let autoplayInterval = null;

  // Popup functions
  function openReviewPopup(review) {
    // Populate popup content - ONLY title, content, and images
    popupTitle.textContent = review.title || 'No Title';
    popupContent.textContent = review.content || '';
    
    // Populate images
    popupImages.innerHTML = '';
    if (review.images && Array.isArray(review.images) && review.images.length > 0) {
      review.images.forEach(image => {
        const img = document.createElement('img');
        img.src = image.url;
        img.alt = image.altText || 'Customer review image';
        img.loading = 'lazy';
        popupImages.appendChild(img);
      });
    }
    
    // Show popup - centered on screen
    popup.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Ensure popup is centered
    setTimeout(() => {
      popup.style.alignItems = 'center';
      popup.style.justifyContent = 'center';
    }, 10);
  }

  function closeReviewPopup() {
    popup.style.display = 'none';
    document.body.style.overflow = '';
  }

  // Event listeners for popup
  popupOverlay.addEventListener('click', closeReviewPopup);
  popupClose.addEventListener('click', closeReviewPopup);

  // Close popup on ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && popup.style.display === 'flex') {
      closeReviewPopup();
    }
  });

  const updateCardWidths = () => {
    const root = document.documentElement;
    root.style.setProperty('--card-width', `${100 / cardsPerPage}%`);
    root.style.setProperty('--card-width-md', `${100 / Math.min(cardsPerPage, 4)}%`);
    root.style.setProperty('--card-width-sm', `${100 / Math.min(cardsPerPage, 3)}%`);
    root.style.setProperty('--card-width-xs', `${100 / Math.min(cardsPerPage, 2)}%`);
  };

  function applySettingsToCss(settings) {
    const root = document.documentElement;
    
    // Existing color settings
    root.style.setProperty('--review-slider-bg', settings.backgroundColor || '#f9f9f9');
    root.style.setProperty('--heading-color', settings.headingColor || '#222222');
    root.style.setProperty('--review-card-bg', settings.reviewCardColor || '#ffffff');
    root.style.setProperty('--star-color', settings.starColor || '#FFD700');
    root.style.setProperty('--section-border-radius', `${settings.sectionBorderRadius || 12}px`);
    
    cardsPerPage = settings.reviewsPerSlide || 3;
    displayType = settings.displayType || 'slider';
    
    // Grid settings
    gridRows = settings.gridRows || 2;
    gridColumns = settings.gridColumns || 2;
    root.style.setProperty('--grid-rows', gridRows);
    root.style.setProperty('--grid-columns', gridColumns);
    
    // Slider settings 
    sliderAutoplay = settings.sliderAutoplay ?? true;
    sliderSpeed = settings.sliderSpeed ?? 3000;
    sliderLoop = settings.sliderLoop ?? true;
    sliderDirection = settings.sliderDirection ?? 'horizontal';
    spaceBetween = settings.spaceBetween ?? 20;
    showNavigation = settings.showNavigation ?? true;
    sliderEffect = settings.sliderEffect ?? 'slide';
    
    // Apply space between to CSS
    root.style.setProperty('--space-between', `${spaceBetween}px`);
    
    // Responsive grid columns
    root.style.setProperty('--grid-columns-sm', Math.min(gridColumns, 3));
    root.style.setProperty('--grid-columns-xs', Math.min(gridColumns, 2));
    
    // Text styling settings - Use 'inherit' for theme font
    root.style.setProperty('--heading-font-family', 
      settings.headingFontFamily === 'theme' ? 'inherit' : (settings.headingFontFamily || 'inherit'));
    root.style.setProperty('--heading-font-size', `${settings.headingFontSize || 40}px`);
    root.style.setProperty('--heading-font-weight', settings.headingFontWeight || 'bold');
    root.style.setProperty('--heading-font-style', settings.headingFontStyle || 'normal');
    root.style.setProperty('--heading-text-transform', settings.headingTextTransform || 'uppercase');
    root.style.setProperty('--heading-letter-spacing', `${settings.headingLetterSpacing || 0}px`);
    root.style.setProperty('--heading-line-height', settings.headingLineHeight || 1.2);
    root.style.setProperty('--heading-text-shadow', settings.headingTextShadow || 'none');
    
    root.style.setProperty('--rating-label-font-family', 
      settings.ratingLabelFontFamily === 'theme' ? 'inherit' : (settings.ratingLabelFontFamily || 'inherit'));
    root.style.setProperty('--rating-label-font-size', `${settings.ratingLabelFontSize || 18}px`);
    root.style.setProperty('--rating-label-font-weight', settings.ratingLabelFontWeight || '600');
    root.style.setProperty('--rating-label-color', settings.ratingLabelColor || '#555555');
    
    root.style.setProperty('--rating-value-font-family', 
      settings.ratingValueFontFamily === 'theme' ? 'inherit' : (settings.ratingValueFontFamily || 'inherit'));
    root.style.setProperty('--rating-value-font-size', `${settings.ratingValueFontSize || 18}px`);
    root.style.setProperty('--rating-value-font-weight', settings.ratingValueFontWeight || '600');
    root.style.setProperty('--rating-value-color', settings.ratingValueColor || '#555555');
    
    root.style.setProperty('--review-count-font-family', 
      settings.reviewCountFontFamily === 'theme' ? 'inherit' : (settings.reviewCountFontFamily || 'inherit'));
    root.style.setProperty('--review-count-font-size', `${settings.reviewCountFontSize || 16}px`);
    root.style.setProperty('--review-count-font-weight', settings.reviewCountFontWeight || 'normal');
    root.style.setProperty('--review-count-color', settings.reviewCountColor || '#777777');
    
    // Update text content
    if (elements.sectionTitle) {
      let headingText = settings.headingText || 'CUSTOMER TESTIMONIALS';
      
      // If text transform is set to capitalize, convert the text to proper case
      if (settings.headingTextTransform === 'capitalize') {
        headingText = headingText.toLowerCase().replace(/\b\w/g, function(char) {
          return char.toUpperCase();
        });
      }
      
      elements.sectionTitle.textContent = headingText;
    }
    if (elements.summaryLabel) {
      elements.summaryLabel.textContent = settings.ratingLabelText || 'Excellent';
    }
    if (elements.summaryReviewCount) {
      const prefix = settings.reviewCountPrefix || 'Based on';
      const suffix = settings.reviewCountSuffix || 'reviews';
      elements.summaryReviewCount.innerHTML = `${prefix} <span class="review-count-value">0</span> ${suffix}`;
      // Re-bind the count element after updating HTML
      elements.count = sliderBlock.querySelector('.review-count-value');
    }
    
    updateCardWidths();
    showCorrectLayout();
    applySliderSettings();
  }

  // Apply slider-specific settings
  function applySliderSettings() {
    if (displayType !== 'slider') return;
    
    // Apply direction
    if (elements.sliderContainer) {
      elements.sliderContainer.className = 'review-carousel-container';
      if (sliderDirection === 'vertical') {
        elements.sliderContainer.classList.add('vertical');
      }
    }
    
    // Apply effect
    if (elements.track) {
      elements.track.className = 'review-carousel-track';
      if (sliderEffect !== 'slide') {
        elements.track.classList.add(`effect-${sliderEffect}`);
      }
    }
    
    // Apply navigation visibility
    if (elements.prevBtn && elements.nextBtn) {
      elements.prevBtn.style.display = showNavigation ? 'flex' : 'none';
      elements.nextBtn.style.display = showNavigation ? 'flex' : 'none';
    }
    
    // Initialize autoplay
    initAutoplay();
  }

  // Initialize autoplay
  function initAutoplay() {
    clearInterval(autoplayInterval);
    
    if (sliderAutoplay && displayType === 'slider' && reviews.length > cardsPerPage) {
      autoplayInterval = setInterval(() => {
        if (currentIndex + cardsPerPage < reviews.length) {
          showNextReviews();
        } else if (sliderLoop) {
          currentIndex = 0;
          renderSliderReviews();
          updateButtons();
        } else {
          clearInterval(autoplayInterval);
        }
      }, sliderSpeed);
    }
  }

  function showCorrectLayout() {
    if (elements.sliderContainer) {
      elements.sliderContainer.style.display = displayType === 'slider' ? 'flex' : 'none';
    }
    if (elements.gridContainer) {
      elements.gridContainer.style.display = displayType === 'grid' ? 'block' : 'none';
     
      if (elements.gridPagination) {
        elements.gridPagination.style.display = displayType === 'grid' ? 'flex' : 'none';
      }
    }
  }

  // Initialize slider
  function initSlider() {
    fetchAppSettings();
    setupEventListeners();
  }

  // Fetch app settings from the API
  function fetchAppSettings() {
    const apiUrl = sliderBlock.dataset.apiUrl;
    if (!apiUrl) {
      console.error('API URL for app settings not found.');
      applySettingsToCss({
        starColor: '#FFD700',
        backgroundColor: '#F9F9F9',
        headingColor: '#222222',
        reviewCardColor: '#FFFFFF',
        reviewsPerSlide: 3,
        displayType: 'slider',
        gridRows: 2,
        gridColumns: 2,
        sliderAutoplay: true,
        sliderSpeed: 3000,
        sliderLoop: true,
        sliderDirection: 'horizontal',
        spaceBetween: 20,
        showNavigation: true,
        sliderEffect: 'slide',
        sectionBorderRadius: 12,
        headingText: "CUSTOMER TESTIMONIALS",
        headingFontFamily: "inherit",
        headingFontSize: 40,
        headingFontWeight: "bold",
        headingFontStyle: "normal",
        headingTextTransform: "uppercase",
        headingLetterSpacing: 0,
        headingLineHeight: 1.2,
        headingTextShadow: "none",
        ratingLabelText: "Excellent",
        ratingLabelFontFamily: "inherit",
        ratingLabelFontSize: 18,
        ratingLabelFontWeight: "600",
        ratingLabelColor: "#555555",
        ratingValueFontFamily: "inherit",
        ratingValueFontSize: 18,
        ratingValueFontWeight: "600",
        ratingValueColor: "#555555",
        reviewCountPrefix: "Based on",
        reviewCountSuffix: "reviews",
        reviewCountFontFamily: "inherit",
        reviewCountFontSize: 16,
        reviewCountFontWeight: "normal",
        reviewCountColor: "#777777"
      });
      fetchReviews();
      return;
    }

    fetch(apiUrl)
      .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || `Failed to load app settings: ${response.status}`);
            }).catch(() => {
                throw new Error(`Failed to load app settings: ${response.status}`);
            });
        }
        return response.json();
      })
      .then(settings => {
        appSettings = settings;
        applySettingsToCss(appSettings);
        fetchReviews();
      })
      .catch(error => {
        console.error('Error fetching app settings:', error);
        applySettingsToCss({
          starColor: '#FFD700',
          backgroundColor: '#F9F9F9',
          headingColor: '#222222',
          reviewCardColor: '#FFFFFF',
          reviewsPerSlide: 3,
          displayType: 'slider',
          gridRows: 2,
          gridColumns: 2,
          sliderAutoplay: true,
          sliderSpeed: 3000,
          sliderLoop: true,
          sliderDirection: 'horizontal',
          spaceBetween: 20,
          showNavigation: true,
          sliderEffect: 'slide',
          sectionBorderRadius: 12,
          headingText: "CUSTOMER TESTIMONIALS",
          headingFontFamily: "inherit",
          headingFontSize: 40,
          headingFontWeight: "bold",
          headingFontStyle: "normal",
          headingTextTransform: "uppercase",
          headingLetterSpacing: 0,
          headingLineHeight: 1.2,
          headingTextShadow: "none",
          ratingLabelText: "Excellent",
          ratingLabelFontFamily: "inherit",
          ratingLabelFontSize: 18,
          ratingLabelFontWeight: "600",
          ratingLabelColor: "#555555",
          ratingValueFontFamily: "inherit",
          ratingValueFontSize: 18,
          ratingValueFontWeight: "600",
          ratingValueColor: "#555555",
          reviewCountPrefix: "Based on",
          reviewCountSuffix: "reviews",
          reviewCountFontFamily: "inherit",
          reviewCountFontSize: 16,
          reviewCountFontWeight: "normal",
          reviewCountColor: "#777777"
        });
        fetchReviews();
      });
  }

  // Fetch reviews from API
  function fetchReviews() {
    showLoading();
    fetch('/apps/productreview/api/productreview')
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => {
            throw new Error(err.error || `Failed to load reviews: ${response.status}`);
          }).catch(() => {
            throw new Error(`Failed to load reviews: ${response.status}`);
          });
        }
        return response.json();
      })
      .then(data => {
        reviews = data.reviews.filter(r => r.status === 'approved')
                             .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

        updateDisplay(parseFloat(data.averageRating), parseInt(data.totalReviews, 10));
      })
      .catch(error => {
        console.error('Error:', error);
        showError(error.message || 'Unknown error');
      })
      .finally(() => {
        sliderBlock.classList.remove('loading');
        sliderBlock.classList.add('loaded');
      });
  }

  function updateDisplay(averageRating, totalReviews) {
    updateSummary(averageRating, totalReviews);
    renderReviews();
    updateButtons();
    initAutoplay();
  }

  function updateSummary(averageRating, totalReviews) {
    elements.avgRating.textContent = averageRating.toFixed(1);
    elements.starsContainer.innerHTML = renderSummaryStars(averageRating);
    if (elements.count) {
      elements.count.textContent = totalReviews;
    }
  }

  function renderSummaryStars(rating) {
    let starsHtml = '';
    const fullStars = Math.floor(rating);
    const partialStarFill = (rating % 1) * 100;

    for (let i = 1; i <= 5; i++) {
      if (i <= fullStars) {
        starsHtml += '<span class="star-icon full-star-summary">★</span>';
      } else if (i === fullStars + 1 && partialStarFill > 0) {
        starsHtml += `<span class="star-icon partial-star-summary" style="--fill-percentage: ${partialStarFill}%">★</span>`;
      } else {
        starsHtml += '<span class="star-icon">★</span>';
      }
    }
    return starsHtml;
  }

  function renderStars(rating) {
    let stars = '';
    const roundedRating = Math.round(rating);

    for (let i = 1; i <= 5; i++) {
      if (i <= roundedRating) {
        stars += '★';
      } else {
        stars += '☆';
      }
    }
    return stars;
  }

  function renderReviews() {
    if (reviews.length === 0) {
      const emptyMessage = '<p class="loading-reviews-slider">No reviews found</p>';
      if (elements.track) elements.track.innerHTML = emptyMessage;
      if (elements.grid) elements.grid.innerHTML = emptyMessage;
      return;
    }

    if (displayType === 'slider') {
      renderSliderReviews();
    } else {
      renderGridReviews();
    }
  }

  function renderSliderReviews() {
    if (!elements.track) return;

    elements.track.innerHTML = '';
    const fragment = document.createDocumentFragment();

    const endIndex = Math.min(currentIndex + cardsPerPage, reviews.length);

    for (let i = currentIndex; i < endIndex; i++) {
      const review = reviews[i];
      const reviewCard = createReviewCard(review);
      fragment.appendChild(reviewCard);
    }

    elements.track.appendChild(fragment);
    applyEffectTransforms();
  }

  // Apply effect-specific transformations
  function applyEffectTransforms() {
    if (!elements.track) return;
    const cards = elements.track.querySelectorAll('.review-card');
    if (cards.length === 0) return;
    const centerIndex = currentIndex;
    cards.forEach((card, index) => {
      const difference = index - centerIndex;
      let transformStyle = '';
      if (sliderEffect === 'cube') {
        const rotationY = difference * 90; 
        transformStyle = `rotateY(${rotationY}deg) translateZ(${cards[0].offsetWidth / 2}px)`; 
      } else if (sliderEffect === 'coverflow') {
        const rotationY = difference * -30;
        const offset = difference * 50; 
        const translateZ = Math.abs(difference) * -100;
        transformStyle = `perspective(1000px) translateX(${offset}px) rotateY(${rotationY}deg) translateZ(${translateZ}px)`;
      }
      card.style.transform = transformStyle;
    });
  }

  // Render reviews for grid layout
  function renderGridReviews() {
    if (!elements.grid) return;

    elements.grid.innerHTML = '';
    const fragment = document.createDocumentFragment();

    // Calculate grid items per page
    const itemsPerPage = gridRows * gridColumns;
    const startIndex = gridCurrentPage * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, reviews.length);

    for (let i = startIndex; i < endIndex; i++) {
      const review = reviews[i];
      const reviewCard = createReviewCard(review);
      fragment.appendChild(reviewCard);
    }

    elements.grid.appendChild(fragment);
    updateGridPagination();
  }

  // Update grid pagination buttons
  function updateGridPagination() {
    if (!elements.gridPrevBtn || !elements.gridNextBtn) return;
    
    const itemsPerPage = gridRows * gridColumns;
    const totalPages = Math.ceil(reviews.length / itemsPerPage);
    
    elements.gridPrevBtn.disabled = gridCurrentPage === 0;
    elements.gridNextBtn.disabled = gridCurrentPage >= totalPages - 1;
  }

  // Create a single review card with Read More functionality
  function createReviewCard(review) {
    const reviewCard = document.createElement('div');
    reviewCard.classList.add('review-card');

    let imagesHtml = '';
    if (review.images && Array.isArray(review.images) && review.images.length > 0) {
      imagesHtml += '<div class="review-card-images-container">';
      review.images.forEach(image => {
        imagesHtml += `<img src="${image.url}" alt="${image.altText || 'Customer review image'}" loading="lazy" />`;
      });
      imagesHtml += '</div>';
    }

    const content = review.content || '';
    
    // Simple and reliable detection: if content has more than 250 characters, show Read More
    const needsReadMore = content.length > 250;
    
    // Create short content - first 200 characters
    const shortContent = needsReadMore ? content.substring(0, 200) + '...' : content;

    reviewCard.innerHTML = `
      <div class="review-card-rating">${renderStars(parseFloat(review.rating))}</div>
      <h3 class="review-card-title">${review.title || 'No Title'}</h3>
      <div class="review-card-content ${needsReadMore ? 'collapsed' : ''}">
        ${needsReadMore ? shortContent : content}
      </div>
      ${needsReadMore ? '<button class="read-more-btn">Read More</button>' : ''}
      ${imagesHtml}
      <p class="review-card-meta">
        by ${review.author || 'Anonymous'} • ${new Date(review.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
      </p>
    `;

    // Add event listener for Read More button
    if (needsReadMore) {
      const readMoreBtn = reviewCard.querySelector('.read-more-btn');
      
      readMoreBtn.addEventListener('click', function() {
        openReviewPopup(review);
      });
    }

    return reviewCard;
  }

  // Update navigation buttons (for slider only)
  function updateButtons() {
    if (elements.prevBtn) elements.prevBtn.disabled = currentIndex === 0 || displayType !== 'slider';
    if (elements.nextBtn) elements.nextBtn.disabled = currentIndex + cardsPerPage >= reviews.length || displayType !== 'slider';
  }

  // Show loading state
  function showLoading() {
    const loadingMessage = '<p class="loading-reviews-slider">Loading reviews...</p>';
    if (elements.track) elements.track.innerHTML = loadingMessage;
    if (elements.grid) elements.grid.innerHTML = loadingMessage;
    sliderBlock.classList.add('loading');
  }

  // Show error state
  function showError(message = 'Error loading reviews') {
    const errorMessage = `<p class="loading-reviews-slider">${message}</p>`;
    if (elements.track) elements.track.innerHTML = errorMessage;
    if (elements.grid) elements.grid.innerHTML = errorMessage;
    elements.avgRating.textContent = '0.0';
    elements.starsContainer.innerHTML = renderSummaryStars(0);
    if (elements.count) {
      elements.count.textContent = '0';
    }
    if (elements.prevBtn) elements.prevBtn.disabled = true;
    if (elements.nextBtn) elements.nextBtn.disabled = true;
    if (elements.gridPrevBtn) elements.gridPrevBtn.disabled = true;
    if (elements.gridNextBtn) elements.gridNextBtn.disabled = true;
  }

  // Handle next slide (slider only)
  function showNextReviews() {
    if (displayType === 'slider' && currentIndex + cardsPerPage < reviews.length) {
      currentIndex += cardsPerPage;
      renderSliderReviews();
      updateButtons();
    } else if (displayType === 'slider' && sliderLoop) {
      currentIndex = 0;
      renderSliderReviews();
      updateButtons();
    }
  }

  // Handle previous slide (slider only)
  function showPrevReviews() {
    if (displayType === 'slider' && currentIndex > 0) {
      currentIndex = Math.max(0, currentIndex - cardsPerPage);
      renderSliderReviews();
      updateButtons();
    } else if (displayType === 'slider' && sliderLoop) {
      currentIndex = Math.max(0, reviews.length - cardsPerPage);
      renderSliderReviews();
      updateButtons();
    }
  }

  // Handle next page (grid only)
  function showNextGridPage() {
    const itemsPerPage = gridRows * gridColumns;
    const totalPages = Math.ceil(reviews.length / itemsPerPage);
    
    if (gridCurrentPage < totalPages - 1) {
      gridCurrentPage++;
      renderGridReviews();
    }
  }

  // Handle previous page (grid only)
  function showPrevGridPage() {
    if (gridCurrentPage > 0) {
      gridCurrentPage--;
      renderGridReviews();
    }
  }

  function handleResize() {
    if (displayType === 'slider') {
      updateCardWidths();
      renderSliderReviews();
      updateButtons();
    } else if (displayType === 'grid') {
      renderGridReviews();
    }
  }

  // Set up event listeners
  function setupEventListeners() {
    if (elements.prevBtn) elements.prevBtn.addEventListener('click', showPrevReviews);
    if (elements.nextBtn) elements.nextBtn.addEventListener('click', showNextReviews);
    if (elements.gridPrevBtn) elements.gridPrevBtn.addEventListener('click', showPrevGridPage);
    if (elements.gridNextBtn) elements.gridNextBtn.addEventListener('click', showNextGridPage);
    window.addEventListener('resize', handleResize);
    
    // Pause autoplay on hover
    if (elements.sliderContainer) {
      elements.sliderContainer.addEventListener('mouseenter', () => {
        clearInterval(autoplayInterval);
      });
      
      elements.sliderContainer.addEventListener('mouseleave', () => {
        initAutoplay();
      });
    }
  }

  initSlider();
});
</script>

{% schema %}
{
  "name": "Review Display",
  "target": "section",
  "settings": []
}
{% endschema %}