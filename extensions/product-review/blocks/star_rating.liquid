{% comment %}
  ================ Star Rating with Reviews Section ================

  This section displays star ratings and reviews for a product,
  includes a review submission form, and manages pagination.
  Star colors are controlled via an external Shopify App's settings API.

  ======================================================
{% endcomment %}

{% liquid
  assign product = block.settings.product
  assign avg_rating_initial = product.metafields.reviews.rating.value | round: 1 | default: 0
  assign review_count_initial = product.metafields.reviews.count.value | default: 0
%}

<div class="star-rating-block loading" data-product-id="{{ product.id }}">
  <div class="rating-header">
    <div class="rating-left">
      <span class="rating-label">Rating</span>
      <span class="stars-container"> {# Color will be set by JS via CSS variable #}
      </span>
      <span class="average-rating">
        {% if review_count_initial > 0 %}
          {{ avg_rating_initial }}
        {% else %}
          0.0
        {% endif %}
      </span>
    </div>
    <div class="rating-right">
      <button type="button" class="write-review-btn">
        {{ 'ratings.reviews.write' | t }}
      </button>
    </div>
  </div>

  <div class="reviews-summary">
    <span class="review-count">{{ review_count_initial }} reviews</span>
  </div>

  <div class="reviews-container">
    <div class="reviews-list">
      <p class="loading-reviews">{{ 'ratings.reviews.loading' | t }}</p>
    </div>

    <div class="reviews-footer" style="display: none;">
      <div class="pagination-controls">
        <button class="prev-page" disabled>&larr; Previous</button>
        <span class="page-indicator">Page 1</span>
        <button class="next-page">Next &rarr;</button>
      </div>
    </div>
  </div>
</div>

<div id="review-form-modal-{{ product.id }}" class="review-form-modal" style="display:none;">
  <div class="modal-overlay"></div>
  <div class="modal-content">
    <button class="close-modal">&times;</button>
    <h3>{{ 'ratings.reviews.write' | t }}</h3>
    <form class="review-form" data-product-id="{{ product.id }}">
      <div class="form-group">
        <label>{{ 'ratings.reviews.your_rating' | t }}</label>
        <div class="star-rating-input">
          {% for i in (1..5) %}
            <input type="radio" id="star{{ i }}-{{ product.id }}" name="rating" value="{{ i }}" required>
            <label for="star{{ i }}-{{ product.id }}">★</label>
          {% endfor %}
        </div>
      </div>

      <div class="form-group">
        <label for="name-{{ product.id }}">{{ 'ratings.reviews.your_name' | t }}</label>
        <input type="text" id="name-{{ product.id }}" name="name" required>
      </div>

      <div class="form-group">
        <label for="email-{{ product.id }}">{{ 'ratings.reviews.your_email' | t }}</label>
        <input type="email" id="email-{{ product.id }}" name="email" required>
      </div>

      <div class="form-group">
        <label for="title-{{ product.id }}">{{ 'ratings.reviews.review_title' | t }}</label>
        <input type="text" id="title-{{ product.id }}" name="title">
      </div>

      <div class="form-group">
        <label for="content-{{ product.id }}">{{ 'ratings.reviews.your_review' | t }}</label>
        <textarea id="content-{{ product.id }}" name="content" required></textarea>
      </div>

      <div class="form-group">
          <label for="image-upload-{{ product.id }}">Upload Images (Optional)</label>
          <input type="file" id="image-upload-{{ product.id }}" name="images" accept="image/jpeg,image/png,image/gif" multiple>
          <small class="form-help-text">Max 5 images. Each max 2MB. JPG, PNG, GIF only.</small>
          <div id="image-preview-{{ product.id }}" class="image-preview"></div>
      </div>

      <button type="submit" class="submit-review">
        {{ 'ratings.reviews.submit' | t }}
      </button>
    </form>
  </div>
</div>


<div id="submission-message-modal" class="review-form-modal" style="display:none;">
  <div class="modal-overlay"></div>
  <div class="modal-content">
    <button class="close-submission-modal">&times;</button>
    <h3 class="submission-message-title">Thank you!</h3>
    <p class="submission-message-text">Your review has been successfully submitted and is awaiting administrator approval.</p>
    <button class="ok-submission-btn">OK</button>
  </div>
</div>


<style>
/* Base Styles */
.star-rating-block {
  padding: 1.5rem;
  margin-bottom: 2rem;
  width: 100%;
  box-sizing: border-box;
  background: #ffffff;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  color: #333;
}
.star-rating-block.loading {
  opacity: 0;
  height: 0;
  overflow: hidden;
}

.star-rating-block.loaded {
  opacity: 1;
  height: auto;
  transition: opacity 0.3s ease;
}
.rating-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  gap: 1.5rem;
}

.rating-left {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.rating-right {
  display: flex;
  align-items: center;
}

.rating-label {
  font-weight: 600;
  font-size: 1rem;
  color: #222;
}

.stars-container .star-icon-main {
  display: inline-block;
  font-size: 1.4rem; 
  line-height: 1;
  vertical-align: middle;
  color: #a0a0a0; 
  position: relative; 
}

.stars-container .full-star-main {
  color: var(--app-star-color, #FFD700); 
}

.stars-container .partial-star-main::before {
  content: '★'; 
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  color: var(--app-star-color, #FFD700); 
  overflow: hidden;
  white-space: nowrap;
  width: var(--fill-percentage); 
}

.average-rating {
  font-size: 1rem;
  color: #555;
  font-weight: 600;
}

.reviews-summary {
  display: flex;
  align-items: center;
  margin-bottom: 0.5rem;
}

.review-count {
  font-weight: 500;
  color: #555;
  font-size: 0.95rem;
}

.reviews-container {
  margin-top: 1rem;
  display: block;
  max-height: 600px;
  overflow-y: auto;
  width: 1500px;
}

.reviews-list {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
}

.review-item {
  padding: 1.5rem;
  border-bottom: 1px solid #eee;
  background-color: #fafafa;
}

.review-item:last-child {
  border-bottom: none;
}

.review-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.review-author {
  font-weight: 600;
  color: #222;
  font-size: 0.95rem;
}

.review-date {
  color: #777;
  font-size: 0.85rem;
}

.review-rating {
  margin: 0.5rem 0;
  font-size: 1.1rem;

  color: var(--app-star-color, #FFD700);
  letter-spacing: 1px;
}

.review-title {
  margin: 0.5rem 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: #333;
}

.review-content {
  line-height: 1.6;
  color: #444;
  font-size: 0.95rem;
  margin-top: 0.5rem;
}

.review-images-container {
  margin-top: 1rem;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: flex-start;
}

.review-images-container img {
  max-width: 120px;
  max-height: 120px;
  width: auto;
  height: auto;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  object-fit: contain;
  border: 1px solid #eee;
  padding: 5px;
  background-color: #f0f0f0;
}

.no-reviews, .loading-reviews {
  color: #888;
  font-style: italic;
  text-align: center;
  padding: 2rem 0;
}

.reviews-footer {
  display: flex;
  justify-content: center;
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid #eee;
}

.pagination-controls button {
  background: #f8f8f8;
  border: 1px solid #dcdcdc;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  font-size: 0.9rem;
  color: #555;
}

.pagination-controls button:hover:not(:disabled) {

  border-color: var(--app-star-color, #FFD700);
  color: #ffffff;
  background-color: var(--app-star-color, #FFD700);
}

.pagination-controls button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  background-color: #f2f2f2;
  color: #999;
}

.page-indicator {
  font-size: 0.9rem;
  color: #666;
  font-weight: 500;
}

.write-review-btn {
 
  background: var(--app-star-color, #FFD700);
  color: white;
  padding: 0.7rem 1.5rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.95rem;
  transition: background 0.2s ease-in-out;
  white-space: nowrap;
}

.write-review-btn:hover {

  background: var(--app-star-color-darken, #E6C200);
}

.review-form-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow-y: auto;
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
}

.modal-content {
  position: relative;
  background: white;
  margin: 1rem;
  padding: 2rem;
  border-radius: 8px;
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
}

.close-modal {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #aaa;
}

.close-modal:hover {
  color: #555;
}

.modal-content h3 {
  margin-top: 0;
  margin-bottom: 1.5rem;
  font-size: 1.5rem;
  color: #222;
  text-align: center;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: #333;
  font-size: 1rem;
}

.form-group input,
.form-group textarea {
  width: 100%;
  padding: 0.8rem;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 0.95rem;
}

.form-group textarea {
  min-height: 120px;
  resize: vertical;
}

.star-rating-input {
  display: flex;
  gap: 5px;
  justify-content: flex-start;
}

.star-rating-input input {
  display: none;
}

.star-rating-input label {
  font-size: 28px;
  color: #e0e0e0;
  cursor: pointer;
}


.star-rating-input input:checked ~ label,
.star-rating-input label:hover,
.star-rating-input input:checked + label {
  color: var(--app-star-color, #FFD700);
}

.submit-review {
  width: 100%;
  padding: 1rem;
  /* Use the CSS variable */
  background: var(--app-star-color, #FFD700);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1rem;
}

.submit-review:hover {
 
  background: var(--app-star-color-darken, #E6C200);
}

.submission-message-title {
  font-size: 1.8rem;
  font-weight: bold;
  color: #28a745;
  text-align: center;
  margin-bottom: 1rem;
}

.submission-message-text {
  font-size: 1rem;
  color: #444;
  text-align: center;
  margin-bottom: 1.5rem;
  line-height: 1.5;
}

.ok-submission-btn {
  width: 100%;
  padding: 0.8rem;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1rem;
  transition: background 0.2s ease-in-out;
}

.ok-submission-btn:hover {
  background: #0056b3;
}

.image-preview {
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: flex-start;
  align-items: center;
  min-height: 50px;
  border: 1px dashed #ddd;
  border-radius: 8px;
  padding: 5px;
}

.image-preview-item {
  position: relative;
  max-width: 80px;
  max-height: 80px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.image-preview-item img {
  max-width: 100%;
  max-height: 100%;
  border-radius: 8px;
  object-fit: contain;
  border: 1px solid #eee;
}

.image-preview-item .remove-image-btn {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 0.8rem;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  padding: 0;
  line-height: 1;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: background 0.2s ease;
}

.image-preview-item .remove-image-btn:hover {
  background: #c82333;
}

.form-help-text {
  font-size: 0.85rem;
  color: #777;
  margin-top: 5px;
  display: block;
}

@media (max-width: 768px) {
  .rating-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }

  .rating-right {
    width: 100%;
  }

  .write-review-btn {
    width: 100%;
  }

  .reviews-container {
    max-height: 500px;
    width: 100%;
    max-width: 100%;
  }
}
</style>

<script>

function darkenColor(hex, percent) {
  let r = parseInt(hex.slice(1, 3), 16);
  let g = parseInt(hex.slice(3, 5), 16);
  let b = parseInt(hex.slice(5, 7), 16);

  r = Math.floor(r * (1 - percent / 100));
  g = Math.floor(g * (1 - percent / 100));
  b = Math.floor(b * (1 - percent / 100));

  r = Math.max(0, Math.min(255, r));
  g = Math.max(0, Math.min(255, g));
  b = Math.max(0, Math.min(255, b));

  const toHex = (c) => ('0' + c.toString(16)).slice(-2);
  return '#' + toHex(r) + toHex(g) + toHex(b);
}

document.addEventListener('DOMContentLoaded', function() {
  const starRatingBlock = document.querySelector('.star-rating-block');
  const productId = starRatingBlock ? starRatingBlock.dataset.productId : null;
  const reviewsContainer = starRatingBlock ? starRatingBlock.querySelector('.reviews-container') : null;
  const reviewsList = reviewsContainer ? reviewsContainer.querySelector('.reviews-list') : null;
  const reviewCountSpan = starRatingBlock ? starRatingBlock.querySelector('.review-count') : null;
  const averageRatingSpan = starRatingBlock ? starRatingBlock.querySelector('.average-rating') : null;
  const starsRenderContainer = starRatingBlock ? starRatingBlock.querySelector('.rating-header .stars-container') : null;
  const prevPageButton = starRatingBlock ? starRatingBlock.querySelector('.prev-page') : null;
  const nextPageButton = starRatingBlock ? starRatingBlock.querySelector('.next-page') : null;
  const pageIndicator = starRatingBlock ? starRatingBlock.querySelector('.page-indicator') : null;

  const submissionMessageModal = document.getElementById('submission-message-modal');
  const closeSubmissionModalBtn = submissionMessageModal ? submissionMessageModal.querySelector('.close-submission-modal') : null;
  const okSubmissionBtn = submissionMessageModal ? submissionMessageModal.querySelector('.ok-submission-btn') : null;

  const MAX_IMAGES_ALLOWED = 5;
  const MAX_FILE_SIZE_MB = 2;

  let currentAppStarColor = '#FFD700';
  let currentAppStarColorDarken = '#E6C200';

 
  fetch('/apps/productreview/api/settings') 
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data && data.starColor) {
        currentAppStarColor = data.starColor;
        currentAppStarColorDarken = darkenColor(currentAppStarColor, 8); 

    
        document.documentElement.style.setProperty('--app-star-color', currentAppStarColor);
        document.documentElement.style.setProperty('--app-star-color-darken', currentAppStarColorDarken);

      } else {
        console.warn('Star color not found in app settings API response. Using default.');
      }
    })
    .catch(error => {
      console.error('Error fetching app settings for star color:', error);
     
    })
    .finally(() => {
      
        loadReviews();
    });


  let allReviews = [];
  let reviewsPerPage = 5;
  let currentPage = 1;

function renderMainRatingStars(rating) {
  let starsHtml = '';
  const fullStars = Math.floor(rating);
  const partialStarFill = (rating % 1) * 100; // Get the percentage for the partial star

  for (let i = 1; i <= 5; i++) {
    if (i <= fullStars) {
      // Full star for main rating
      starsHtml += '<span class="star-icon-main full-star-main">★</span>';
    } else if (i === fullStars + 1 && partialStarFill > 0) {
      // Partial star for main rating
      starsHtml += `<span class="star-icon-main partial-star-main" style="--fill-percentage: ${partialStarFill}%">★</span>`;
    } else {
      // Empty star for main rating 
      starsHtml += '<span class="star-icon-main">★</span>';
    }
  }
  return starsHtml;
}

function renderStars(rating) {
  let stars = '';
  const roundedRating = Math.round(rating); 

  for (let i = 1; i <= 5; i++) {
    if (i <= roundedRating) {
      stars += '★'; // Solid star
    } else {
      stars += '☆'; // Empty outline star
    }
  }
  return stars;
}
  function renderReviews() {
    if (!reviewsList) return;

    reviewsList.innerHTML = '';
    const reviewsFooter = starRatingBlock.querySelector('.reviews-footer');

    if (allReviews.length === 0) {
      reviewsList.innerHTML = `<p class="no-reviews">No reviews yet</p>`;
      if (reviewsFooter) reviewsFooter.style.display = 'none';
      return;
    }

    const startIndex = (currentPage - 1) * reviewsPerPage;
    const endIndex = startIndex + reviewsPerPage;
    const reviewsToDisplay = allReviews.slice(startIndex, endIndex);

    reviewsToDisplay.forEach(review => {
      const reviewItem = document.createElement('div');
      reviewItem.classList.add('review-item');

      let imagesHtml = '';
      if (review.images && Array.isArray(review.images) && review.images.length > 0) {
        imagesHtml += `<div class="review-images-container">`;
        review.images.forEach(image => {
          imagesHtml += `<img src="${image.url}" alt="${image.altText || 'Customer review image'}" />`;
        });
        imagesHtml += `</div>`;
      }

      reviewItem.innerHTML = `
        <div class="review-meta">
          <span class="review-author">${review.author || 'Anonymous'}</span>
          <span class="review-date">${new Date(review.createdAt).toLocaleDateString()}</span>
        </div>
        <div class="review-rating" style="color:var(--app-star-color, #FFD700);">
          ${renderStars(parseFloat(review.rating))}
        </div>
        ${review.title ? `<h4 class="review-title">${review.title}</h4>` : ''}
        <div class="review-content">${review.content}</div>
        ${imagesHtml}
      `;
      reviewsList.appendChild(reviewItem);
    });

    if (reviewsFooter) {
      reviewsFooter.style.display = allReviews.length > reviewsPerPage ? 'block' : 'none';
    }

    updatePaginationControls();
  }

  function updatePaginationControls() {
    const totalPages = Math.ceil(allReviews.length / reviewsPerPage);

    if (prevPageButton) {
      prevPageButton.disabled = currentPage === 1;
    }
    if (nextPageButton) {
      nextPageButton.disabled = currentPage === totalPages || totalPages === 0;
    }
    if (pageIndicator) {
      pageIndicator.textContent = `Page ${currentPage} of ${totalPages}`;
    }
  }

  async function loadReviews() {
  if (!productId || !reviewsList) {
    console.warn("Product ID or reviews container not found, cannot load reviews.");
    if (reviewsList) {
      reviewsList.innerHTML = `<p class="no-reviews">No reviews yet</p>`;
    }
    starRatingBlock.classList.remove('loading');
    starRatingBlock.classList.add('loaded');
    return;
  }

    starRatingBlock.classList.add('loading');
    reviewsList.innerHTML = `<p class="loading-reviews">Loading reviews...</p>`;

    try {
      const response = await fetch(`/apps/productreview/api/productreview?productId=${productId}`);

      if (!response.ok) {
        const errorData = await response.json().catch(() => null);
        throw new Error(errorData?.error || `Failed to load reviews: ${response.status}`);
      }

      const responseData = await response.json();
      allReviews = Array.isArray(responseData) ? responseData : [];


      if (allReviews.length > 0) {
        let totalRating = 0;
        allReviews.forEach(review => {
          totalRating += parseFloat(review.rating);
        });

        const newAvgRating = (totalRating / allReviews.length);
        if (averageRatingSpan) {
          averageRatingSpan.textContent = newAvgRating.toFixed(1);
        }
        if (reviewCountSpan) {
          reviewCountSpan.textContent = `${allReviews.length} reviews`;
        }
        if (starsRenderContainer) {
          starsRenderContainer.innerHTML = renderMainRatingStars(newAvgRating); 
        }
        currentPage = 1;
        renderReviews();
      } else {
        reviewsList.innerHTML = `<p class="no-reviews">No reviews yet</p>`;
        if (reviewCountSpan) {
          reviewCountSpan.textContent = `0 reviews`;
        }
        if (averageRatingSpan) {
          averageRatingSpan.textContent = '0.0';
        }
        if (starsRenderContainer) {
          starsRenderContainer.innerHTML = renderMainRatingStars(0); 
        }
        updatePaginationControls();
      }
        starRatingBlock.classList.remove('loading');
        starRatingBlock.classList.add('loaded');


    } catch (error) {
    console.error("Error loading reviews:", error);
    starRatingBlock.classList.remove('loading');
    starRatingBlock.classList.add('loaded');
  }
}
  // loadReviews() is now called inside the .finally() block of the fetch request
  // to ensure app settings (color) are loaded first.


  if (prevPageButton) {
    prevPageButton.addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        renderReviews();
      }
    });
  }

  if (nextPageButton) {
    nextPageButton.addEventListener('click', function() {
      const totalPages = Math.ceil(allReviews.length / reviewsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderReviews();
      }
    });
  }

  document.querySelectorAll('.write-review-btn').forEach(button => {
    button.addEventListener('click', function() {
      const modal = document.getElementById(`review-form-modal-${productId}`);
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    });
  });

  document.querySelectorAll('.close-modal, .modal-overlay').forEach(element => {
    element.addEventListener('click', function() {
      this.closest('.review-form-modal').style.display = 'none';
      document.body.style.overflow = '';
    });
  });

  document.querySelectorAll('.star-rating-input').forEach(starInputContainer => {
    const labels = starInputContainer.querySelectorAll('label');
    const inputs = starInputContainer.querySelectorAll('input');

    const updateStars = (ratingValue) => {
        labels.forEach((star, index) => {
            // Use the currentAppStarColor variable (fetched from API)
            star.style.color = index < ratingValue ? currentAppStarColor : '#e0e0e0';
        });
    };

    // Initial state if a radio button is pre-selected (e.g., from browser autofill)
    const initialCheckedInput = starInputContainer.querySelector('input:checked');
    if (initialCheckedInput) {
      updateStars(initialCheckedInput.value);
    }

    labels.forEach(label => {
        label.addEventListener('mouseover', function() {
            const ratingValue = this.previousElementSibling.value;
            updateStars(ratingValue);
        });

        label.addEventListener('mouseout', function() {
            const checkedInput = starInputContainer.querySelector('input:checked');
            if (checkedInput) {
                updateStars(checkedInput.value);
            } else {
                updateStars(0);
            }
        });

        label.addEventListener('click', function() {
            const ratingValue = this.previousElementSibling.value;
            updateStars(ratingValue);
        });
    });
  });

  document.querySelectorAll('.review-form').forEach(form => {
    const productId = form.dataset.productId;
    const imageUploadInput = form.querySelector(`#image-upload-${productId}`);
    const imagePreviewContainer = form.querySelector(`#image-preview-${productId}`);
    let selectedFiles = [];

    const renderImagePreviews = () => {
      if (!imagePreviewContainer) return;
      imagePreviewContainer.innerHTML = '';

      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const imgItem = document.createElement('div');
          imgItem.classList.add('image-preview-item');
          imgItem.innerHTML = `
            <img src="${e.target.result}" alt="Preview of ${file.name}" data-index="${index}" />
            <button type="button" class="remove-image-btn" data-index="${index}">&times;</button>
          `;
          imagePreviewContainer.appendChild(imgItem);

          imgItem.querySelector('.remove-image-btn').addEventListener('click', function() {
            const idxToRemove = parseInt(this.dataset.index);
            selectedFiles.splice(idxToRemove, 1);
            renderImagePreviews();
            if (selectedFiles.length === 0) {
              imageUploadInput.value = '';
            }
          });
        };
        reader.readAsDataURL(file);
      });

      if (selectedFiles.length > MAX_IMAGES_ALLOWED) {
          const helpText = form.querySelector('.form-help-text');
          if(helpText) helpText.innerHTML = `Max ${MAX_IMAGES_ALLOWED} images. Each max ${MAX_FILE_SIZE_MB}MB. JPG, PNG, GIF only. <span style="color: red;">(You have selected ${selectedFiles.length} images. Only the first ${MAX_IMAGES_ALLOWED} will be uploaded.)</span>`;
      } else {
          const helpText = form.querySelector('.form-help-text');
          if(helpText) helpText.innerHTML = `Max ${MAX_IMAGES_ALLOWED} images. Each max ${MAX_FILE_SIZE_MB}MB. JPG, PNG, GIF only.`;
      }
    };

    if (imageUploadInput && imagePreviewContainer) {
        imageUploadInput.addEventListener('change', async function(event) {
            const newFiles = Array.from(event.target.files);
            let tempSelectedFiles = [...selectedFiles];

            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];

            for (let i = 0; i < newFiles.length; i++) {
                const file = newFiles[i];
                if (tempSelectedFiles.length >= MAX_IMAGES_ALLOWED) {
                    // No more images can be added if max is reached
                    break;
                }
                if (!allowedTypes.includes(file.type)) {
                    console.warn(`Skipping ${file.name}: Only JPG, PNG, GIF allowed.`);
                    continue;
                }
                if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                    console.warn(`Skipping ${file.name}: File size exceeds ${MAX_FILE_SIZE_MB}MB.`);
                    continue;
                    }
                tempSelectedFiles.push(file);
            }

            selectedFiles = tempSelectedFiles;
            this.value = '';

            renderImagePreviews();
        });
    }

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const submitBtn = this.querySelector('.submit-review');
      const currentProductId = this.dataset.productId;

      if (!this.checkValidity()) {
        this.reportValidity();
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const formData = new FormData(this);
        const base64Images = [];

        for (let i = 0; i < Math.min(selectedFiles.length, MAX_IMAGES_ALLOWED); i++) {
            const file = selectedFiles[i];
            const reader = new FileReader();
            const base64Data = await new Promise((resolve, reject) => {
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
            base64Images.push(base64Data);
        }

        const response = await fetch('/apps/productreview/api/productreview', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            productId: currentProductId,
            rating: parseFloat(formData.get('rating')),
            author: formData.get('name'),
            email: formData.get('email'),
            title: formData.get('title'),
            content: formData.get('content'),
            images: base64Images
          })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => null);
          throw new Error(
            errorData?.error ||
            `Request failed with status ${response.status}`
          );
        }

        const result = await response.json();
        submitBtn.textContent = 'Submitted! Thank you.';

        const reviewFormModal = document.getElementById(`review-form-modal-${currentProductId}`);
        if (reviewFormModal) {
            reviewFormModal.style.display = 'none';
        }

        if (submissionMessageModal) {
            submissionMessageModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        form.reset();
        selectedFiles = [];
        renderImagePreviews();
        loadReviews();

      } catch (error) {
        console.error('Submission error:', error);
        if (submissionMessageModal) {
            submissionMessageModal.querySelector('.submission-message-title').textContent = 'Submission Failed!';
            submissionMessageModal.querySelector('.submission-message-title').style.color = '#dc3545';
            submissionMessageModal.querySelector('.submission-message-text').textContent = error.message || 'There was an error submitting your review. Please try again.';
            if (okSubmissionBtn) okSubmissionBtn.style.background = '#dc3545';
            submissionMessageModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        } else {
          
            document.body.style.overflow = '';
         
            alert(error.message || 'Error submitting review');
        }
        submitBtn.textContent = 'Submit Review';
      } finally {
          setTimeout(() => {
            submitBtn.disabled = false;
          }, 2000);
      }
    });
  });

  if (closeSubmissionModalBtn) {
    closeSubmissionModalBtn.addEventListener('click', function() {
      if (submissionMessageModal) {
        submissionMessageModal.style.display = 'none';
        document.body.style.overflow = '';
      }
    });
  }

  if (okSubmissionBtn) {
    okSubmissionBtn.addEventListener('click', function() {
      if (submissionMessageModal) {
        submissionMessageModal.style.display = 'none';
        document.body.style.overflow = '';
      }
      
      submissionMessageModal.querySelector('.submission-message-title').textContent = 'Thank you!';
      submissionMessageModal.querySelector('.submission-message-title').style.color = '#28a745';
      if (okSubmissionBtn) okSubmissionBtn.style.background = '#007bff';
    });
  }


});


document.dispatchEvent(new CustomEvent('ratingUpdated', {
  detail: {
    productId: productId, // This `productId` must be defined in scope for this to work
  }
}));
</script>

{% schema %}
{
  "name": "Star Rating with Reviews",
  "target": "section",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product",
      "autofill": true
    }
  ]
}
{% endschema %}